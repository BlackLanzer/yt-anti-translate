name: Update Chrome Extension

on:
  push:
    tags:
      - v*.*.*

jobs:
  build-chrome-extension:
    name: Build Chrome extension artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Build
        run: |-
          cp -r app dist
          # we archive the dist folder and include SHA commit as the last step
          zip -r chrome-extension-${{ github.event.pull_request.head.sha }}.zip dist

      - name: Archive chrome-extension artifact
        uses: actions/upload-artifact@v2
        with:
          name: chrome-extension-${{ github.sha }}
          path: chrome-extension-${{ github.event.pull_request.head.sha }}.zip
  upload-extension:
      name: Upload extension
      runs-on: ubuntu-latest
      needs: build-chrome-extension
      env:
        # you can optionally specify extension ID here, we do this so that
        # all of our environments (dev, staging, prod) have a consistent ID
        # we can reference. Otherwise the extension ID is autogenerated.
        EXTENSION_ID: ndpmhjnlfkgfalaieeneneenijondgag

      steps:
        - uses: actions/setup-node@v2-beta
          with:
            node-version: "16.10"

        - name: Download bundle artifact
          uses: actions/download-artifact@v3
          with:
            name: chrome-extension-${{ github.sha }}

        - name: Install webstore cli
          run: |-
            npm install -g chrome-webstore-upload-cli

        - name: Upload step
          run: |-
            chrome-webstore-upload publish \\
              --source chrome-extension-${{ github.event.pull_request.head.sha }}.zip \\
              --extension-id ${{ env.EXTENSION_ID }} \\
              --client-id ${{ secrets.CHROME_CLIENT_ID }} \\
              --client-secret ${{ secrets.CHROME_CLIENT_SECRET }} \\
              --refresh-token ${{ secrets.CHROME_REFRESH_TOKEN }}